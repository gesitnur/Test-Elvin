{"ast":null,"code":"var _class, _temp;\nfunction _extends() {\n  _extends = Object.assign || function (target) {\n    for (var i = 1; i < arguments.length; i++) {\n      var source = arguments[i];\n      for (var key in source) {\n        if (Object.prototype.hasOwnProperty.call(source, key)) {\n          target[key] = source[key];\n        }\n      }\n    }\n    return target;\n  };\n  return _extends.apply(this, arguments);\n}\nfunction _assertThisInitialized(self) {\n  if (self === void 0) {\n    throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");\n  }\n  return self;\n}\nfunction _inheritsLoose(subClass, superClass) {\n  subClass.prototype = Object.create(superClass.prototype);\n  subClass.prototype.constructor = subClass;\n  _setPrototypeOf(subClass, superClass);\n}\nfunction _setPrototypeOf(o, p) {\n  _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) {\n    o.__proto__ = p;\n    return o;\n  };\n  return _setPrototypeOf(o, p);\n}\nvar throttle = require('lodash.throttle');\nvar _require = require('@uppy/core'),\n  Plugin = _require.Plugin;\nvar ServiceWorkerStore = require('./ServiceWorkerStore');\nvar IndexedDBStore = require('./IndexedDBStore');\nvar MetaDataStore = require('./MetaDataStore');\n/**\n * The GoldenRetriever plugin — restores selected files and resumes uploads\n * after a closed tab or a browser crash!\n *\n * Uses localStorage, IndexedDB and ServiceWorker to do its magic, read more:\n * https://uppy.io/blog/2017/07/golden-retriever/\n */\n\nmodule.exports = (_temp = _class = /*#__PURE__*/function (_Plugin) {\n  _inheritsLoose(GoldenRetriever, _Plugin);\n  function GoldenRetriever(uppy, opts) {\n    var _this;\n    _this = _Plugin.call(this, uppy, opts) || this;\n    _this.addBlobToStores = function (file) {\n      if (file.isRemote) return;\n      if (_this.ServiceWorkerStore) {\n        _this.ServiceWorkerStore.put(file).catch(function (err) {\n          _this.uppy.log('[GoldenRetriever] Could not store file', 'warning');\n          _this.uppy.log(err);\n        });\n      }\n      _this.IndexedDBStore.put(file).catch(function (err) {\n        _this.uppy.log('[GoldenRetriever] Could not store file', 'warning');\n        _this.uppy.log(err);\n      });\n    };\n    _this.removeBlobFromStores = function (file) {\n      if (_this.ServiceWorkerStore) {\n        _this.ServiceWorkerStore.delete(file.id).catch(function (err) {\n          _this.uppy.log('[GoldenRetriever] Failed to remove file', 'warning');\n          _this.uppy.log(err);\n        });\n      }\n      _this.IndexedDBStore.delete(file.id).catch(function (err) {\n        _this.uppy.log('[GoldenRetriever] Failed to remove file', 'warning');\n        _this.uppy.log(err);\n      });\n    };\n    _this.replaceBlobInStores = function (file) {\n      _this.removeBlobFromStores(file);\n      _this.addBlobToStores(file);\n    };\n    _this.handleRestoreConfirmed = function () {\n      _this.uppy.log('[GoldenRetriever] Restore confirmed, proceeding...'); // start all uploads again when file blobs are restored\n\n      var _this$uppy$getState = _this.uppy.getState(),\n        currentUploads = _this$uppy$getState.currentUploads;\n      if (currentUploads) {\n        Object.keys(currentUploads).forEach(function (uploadId) {\n          _this.uppy.restore(uploadId, currentUploads[uploadId]);\n        });\n        _this.uppy.resumeAll();\n      }\n      _this.uppy.upload();\n      _this.uppy.setState({\n        recoveredState: null\n      });\n    };\n    _this.abortRestore = function () {\n      _this.uppy.log('[GoldenRetriever] Aborting restore...');\n      var fileIDs = Object.keys(_this.uppy.getState().files);\n      _this.deleteBlobs(fileIDs).then(function () {\n        _this.uppy.log(\"[GoldenRetriever] Removed \" + fileIDs.length + \" files\");\n      }).catch(function (err) {\n        _this.uppy.log(\"[GoldenRetriever] Could not remove \" + fileIDs.length + \" files\", 'warning');\n        _this.uppy.log(err);\n      });\n      _this.uppy.cancelAll();\n      _this.uppy.setState({\n        recoveredState: null\n      });\n      MetaDataStore.cleanup(_this.uppy.opts.id);\n    };\n    _this.handleComplete = function (_ref) {\n      var successful = _ref.successful;\n      var fileIDs = successful.map(function (file) {\n        return file.id;\n      });\n      _this.deleteBlobs(fileIDs).then(function () {\n        _this.uppy.log(\"[GoldenRetriever] Removed \" + successful.length + \" files that finished uploading\");\n      }).catch(function (err) {\n        _this.uppy.log(\"[GoldenRetriever] Could not remove \" + successful.length + \" files that finished uploading\", 'warning');\n        _this.uppy.log(err);\n      });\n      _this.uppy.setState({\n        recoveredState: null\n      });\n      MetaDataStore.cleanup(_this.uppy.opts.id);\n    };\n    _this.restoreBlobs = function () {\n      if (_this.uppy.getFiles().length > 0) {\n        Promise.all([_this.loadFileBlobsFromServiceWorker(), _this.loadFileBlobsFromIndexedDB()]).then(function (resultingArrayOfObjects) {\n          var blobs = _extends({}, resultingArrayOfObjects[0], resultingArrayOfObjects[1]);\n          _this.onBlobsLoaded(blobs);\n        });\n      } else {\n        _this.uppy.log('[GoldenRetriever] No files need to be loaded, only restoring processing state...');\n        _this.onBlobsLoaded([]);\n      }\n    };\n    _this.type = 'debugger';\n    _this.id = _this.opts.id || 'GoldenRetriever';\n    _this.title = 'Golden Retriever';\n    var defaultOptions = {\n      expires: 24 * 60 * 60 * 1000,\n      // 24 hours\n      serviceWorker: false\n    };\n    _this.opts = _extends({}, defaultOptions, opts);\n    _this.MetaDataStore = new MetaDataStore({\n      expires: _this.opts.expires,\n      storeName: uppy.getID()\n    });\n    _this.ServiceWorkerStore = null;\n    if (_this.opts.serviceWorker) {\n      _this.ServiceWorkerStore = new ServiceWorkerStore({\n        storeName: uppy.getID()\n      });\n    }\n    _this.IndexedDBStore = new IndexedDBStore(_extends({\n      expires: _this.opts.expires\n    }, _this.opts.indexedDB || {}, {\n      storeName: uppy.getID()\n    }));\n    _this.saveFilesStateToLocalStorage = throttle(_this.saveFilesStateToLocalStorage.bind(_assertThisInitialized(_this)), 500, {\n      leading: true,\n      trailing: true\n    });\n    _this.restoreState = _this.restoreState.bind(_assertThisInitialized(_this));\n    _this.loadFileBlobsFromServiceWorker = _this.loadFileBlobsFromServiceWorker.bind(_assertThisInitialized(_this));\n    _this.loadFileBlobsFromIndexedDB = _this.loadFileBlobsFromIndexedDB.bind(_assertThisInitialized(_this));\n    _this.onBlobsLoaded = _this.onBlobsLoaded.bind(_assertThisInitialized(_this));\n    return _this;\n  }\n  var _proto = GoldenRetriever.prototype;\n  _proto.restoreState = function restoreState() {\n    var savedState = this.MetaDataStore.load();\n    if (savedState) {\n      this.uppy.log('[GoldenRetriever] Recovered some state from Local Storage');\n      this.uppy.setState({\n        currentUploads: savedState.currentUploads || {},\n        files: savedState.files || {},\n        recoveredState: savedState\n      });\n      this.savedPluginData = savedState.pluginData;\n    }\n  }\n  /**\n   * Get file objects that are currently waiting: they've been selected,\n   * but aren't yet being uploaded.\n   */;\n\n  _proto.getWaitingFiles = function getWaitingFiles() {\n    var waitingFiles = {};\n    this.uppy.getFiles().forEach(function (file) {\n      if (!file.progress || !file.progress.uploadStarted) {\n        waitingFiles[file.id] = file;\n      }\n    });\n    return waitingFiles;\n  }\n  /**\n   * Get file objects that are currently being uploaded. If a file has finished\n   * uploading, but the other files in the same batch have not, the finished\n   * file is also returned.\n   */;\n\n  _proto.getUploadingFiles = function getUploadingFiles() {\n    var _this2 = this;\n    var uploadingFiles = {};\n    var _this$uppy$getState2 = this.uppy.getState(),\n      currentUploads = _this$uppy$getState2.currentUploads;\n    if (currentUploads) {\n      var uploadIDs = Object.keys(currentUploads);\n      uploadIDs.forEach(function (uploadID) {\n        var filesInUpload = currentUploads[uploadID].fileIDs;\n        filesInUpload.forEach(function (fileID) {\n          uploadingFiles[fileID] = _this2.uppy.getFile(fileID);\n        });\n      });\n    }\n    return uploadingFiles;\n  };\n  _proto.saveFilesStateToLocalStorage = function saveFilesStateToLocalStorage() {\n    var filesToSave = _extends({}, this.getWaitingFiles(), this.getUploadingFiles()); // If all files have been removed by the user, clear recovery state\n\n    if (Object.keys(filesToSave).length === 0) {\n      this.uppy.setState({\n        recoveredState: null\n      });\n      MetaDataStore.cleanup(this.uppy.opts.id);\n      return;\n    } // We dont’t need to store file.data on local files, because the actual blob will be restored later,\n    // and we want to avoid having weird properties in the serialized object.\n    // Also adding file.isRestored to all files, since they will be restored from local storage\n\n    var filesToSaveWithoutData = {};\n    Object.keys(filesToSave).forEach(function (file) {\n      if (filesToSave[file].isRemote) {\n        filesToSaveWithoutData[file] = _extends({}, filesToSave[file], {\n          isRestored: true\n        });\n      } else {\n        filesToSaveWithoutData[file] = _extends({}, filesToSave[file], {\n          isRestored: true,\n          data: null,\n          preview: null\n        });\n      }\n    });\n    var pluginData = {}; // TODO Find a better way to do this?\n    // Other plugins can attach a restore:get-data listener that receives this callback.\n    // Plugins can then use this callback (sync) to provide data to be stored.\n\n    this.uppy.emit('restore:get-data', function (data) {\n      _extends(pluginData, data);\n    });\n    var _this$uppy$getState3 = this.uppy.getState(),\n      currentUploads = _this$uppy$getState3.currentUploads;\n    this.MetaDataStore.save({\n      currentUploads: currentUploads,\n      files: filesToSaveWithoutData,\n      pluginData: pluginData\n    });\n  };\n  _proto.loadFileBlobsFromServiceWorker = function loadFileBlobsFromServiceWorker() {\n    var _this3 = this;\n    if (!this.ServiceWorkerStore) {\n      return Promise.resolve({});\n    }\n    return this.ServiceWorkerStore.list().then(function (blobs) {\n      var files = _this3.uppy.getFiles();\n      var localFilesOnly = files.filter(function (file) {\n        // maybe && !file.progress.uploadComplete\n        return !file.isRemote;\n      });\n      var numberOfFilesRecovered = Object.keys(blobs).length;\n      var numberOfFilesTryingToRecover = localFilesOnly.length;\n      if (numberOfFilesRecovered === numberOfFilesTryingToRecover) {\n        _this3.uppy.log(\"[GoldenRetriever] Successfully recovered \" + numberOfFilesRecovered + \" blobs from Service Worker!\");\n        return blobs;\n      }\n      _this3.uppy.log('[GoldenRetriever] No blobs found in Service Worker, trying IndexedDB now...');\n      return {};\n    }).catch(function (err) {\n      _this3.uppy.log('[GoldenRetriever] Failed to recover blobs from Service Worker', 'warning');\n      _this3.uppy.log(err);\n      return {};\n    });\n  };\n  _proto.loadFileBlobsFromIndexedDB = function loadFileBlobsFromIndexedDB() {\n    var _this4 = this;\n    return this.IndexedDBStore.list().then(function (blobs) {\n      var numberOfFilesRecovered = Object.keys(blobs).length;\n      if (numberOfFilesRecovered > 0) {\n        _this4.uppy.log(\"[GoldenRetriever] Successfully recovered \" + numberOfFilesRecovered + \" blobs from IndexedDB!\");\n        return blobs;\n      }\n      _this4.uppy.log('[GoldenRetriever] No blobs found in IndexedDB');\n      return {};\n    }).catch(function (err) {\n      _this4.uppy.log('[GoldenRetriever] Failed to recover blobs from IndexedDB', 'warning');\n      _this4.uppy.log(err);\n      return {};\n    });\n  };\n  _proto.onBlobsLoaded = function onBlobsLoaded(blobs) {\n    var _this5 = this;\n    var obsoleteBlobs = [];\n    var updatedFiles = _extends({}, this.uppy.getState().files); // Loop through blobs that we can restore, add blobs to file objects\n\n    Object.keys(blobs).forEach(function (fileID) {\n      var originalFile = _this5.uppy.getFile(fileID);\n      if (!originalFile) {\n        obsoleteBlobs.push(fileID);\n        return;\n      }\n      var cachedData = blobs[fileID];\n      var updatedFileData = {\n        data: cachedData,\n        isRestored: true,\n        isGhost: false\n      };\n      updatedFiles[fileID] = _extends({}, originalFile, updatedFileData);\n    }); // Loop through files that we can’t restore fully — we only have meta, not blobs,\n    // set .isGhost on them, also set isRestored to all files\n\n    Object.keys(updatedFiles).forEach(function (fileID) {\n      if (updatedFiles[fileID].data === null) {\n        updatedFiles[fileID] = _extends({}, updatedFiles[fileID], {\n          isGhost: true\n        });\n      }\n    });\n    this.uppy.setState({\n      files: updatedFiles\n    });\n    this.uppy.emit('restored', this.savedPluginData);\n    if (obsoleteBlobs.length) {\n      this.deleteBlobs(obsoleteBlobs).then(function () {\n        _this5.uppy.log(\"[GoldenRetriever] Cleaned up \" + obsoleteBlobs.length + \" old files\");\n      }).catch(function (err) {\n        _this5.uppy.log(\"[GoldenRetriever] Could not clean up \" + obsoleteBlobs.length + \" old files\", 'warning');\n        _this5.uppy.log(err);\n      });\n    }\n  };\n  _proto.deleteBlobs = function deleteBlobs(fileIDs) {\n    var _this6 = this;\n    var promises = [];\n    fileIDs.forEach(function (id) {\n      if (_this6.ServiceWorkerStore) {\n        promises.push(_this6.ServiceWorkerStore.delete(id));\n      }\n      if (_this6.IndexedDBStore) {\n        promises.push(_this6.IndexedDBStore.delete(id));\n      }\n    });\n    return Promise.all(promises);\n  };\n  _proto.install = function install() {\n    this.restoreState();\n    this.restoreBlobs();\n    this.uppy.on('file-added', this.addBlobToStores);\n    this.uppy.on('file-editor:complete', this.replaceBlobInStores);\n    this.uppy.on('file-removed', this.removeBlobFromStores);\n    this.uppy.on('state-update', this.saveFilesStateToLocalStorage);\n    this.uppy.on('restore-confirmed', this.handleRestoreConfirmed);\n    this.uppy.on('restore-canceled', this.abortRestore);\n    this.uppy.on('complete', this.handleComplete);\n  };\n  _proto.uninstall = function uninstall() {\n    this.uppy.off('file-added', this.addBlobToStores);\n    this.uppy.off('file-editor:complete', this.replaceBlobInStores);\n    this.uppy.off('file-removed', this.removeBlobFromStores);\n    this.uppy.off('state-update', this.saveFilesStateToLocalStorage);\n    this.uppy.off('restore-confirmed', this.handleRestoreConfirmed);\n    this.uppy.off('restore-canceled', this.abortRestore);\n    this.uppy.off('complete', this.handleComplete);\n  };\n  return GoldenRetriever;\n}(Plugin), _class.VERSION = \"1.4.2\", _temp);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}